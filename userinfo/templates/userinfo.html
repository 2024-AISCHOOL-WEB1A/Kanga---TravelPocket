<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 검색 폼</title>
    <link rel="stylesheet" href="../css/userinfo.css">
</head>

<body>
    <div class="search-container">
        <form id="travelForm">
            <div style="position: relative;">
                <input type="text" placeholder="어디로 떠나시나요?" id="destination">
                <div class="dropdown" id="dropdown">
                    <!-- 데이터가 포함된 div 요소들 -->
                    <div data-country-name="일본">일본</div>
                    <div data-country-name="중국">중국</div>
                    <div data-country-name="필리핀">필리핀</div>
                    <div data-country-name="싱가포르">싱가포르</div>
                    <div data-country-name="인도네시아">인도네시아</div>
                    <!-- <div data-country-name="타이완">타이완</div> -->
                    <div data-country-name="태국">태국</div>
                    <div data-country-name="베트남">베트남</div>
                    <div data-country-name="미국">미국</div>
                    <div data-country-name="괌">괌</div>
                    <div data-country-name="캐나다">캐나다</div>
                    <div data-country-name="호주">호주</div>
                </div>
            </div>
            <div class="date-group" id="dateGroup" style="display: none;">
                <div>
                    <label for="start_date">출발 날짜</label>
                    <input type="date" id="checkin">
                </div>
                <div>
                    <label for="end_date">도착 날짜</label>
                    <input type="date" id="checkout">
                </div>
            </div>
            <div class="guest-group" id="guestGroup" style="display: none;">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="child"> 아이</label>
                    <label><input type="checkbox" id="teen"> 청소년</label>
                    <label><input type="checkbox" id="adult"> 성인</label>
                    <label><input type="checkbox" id="pet"> 반려동물</label>
                    <label><input type="checkbox" id="disabled"> 장애인</label>
                </div>
            </div>
            <div>
                <button id="submitBtn" type="submit" style="width: 100%;">출발하기</button>
            </div>
        </form>
    </div>
    <script>
        const destinationInput = document.getElementById('destination');
        const dropdown = document.getElementById('dropdown');
        const dateGroup = document.getElementById('dateGroup');
        const guestGroup = document.getElementById('guestGroup');
        const travelForm = document.getElementById('travelForm');
        let userId;

        async function fetchCountries() {
            try {
                const response = await fetch('/countries');
                if (!response.ok) {
                    throw new Error('국가 데이터를 가져오는 데 실패했습니다');
                }
                const countries = await response.json();
                
                dropdown.querySelectorAll('div').forEach((div) => {
                    const countryName = div.dataset.countryName;
                    const countryData = countries.find(country => country.country_name === countryName);
                    if (countryData) {
                        div.dataset.countryIdx = countryData.country_idx;
                    } else {
                        console.warn("국가 데이터가 없거나 잘못된 국가 이름: ${countryName}");
                    }
                });
            } catch (error) {
                console.error('국가 데이터를 가져오는 데 오류 발생:', error);
            }
        }

   

   

        async function fetchUserInfo() {
            try {
                const response = await fetch('/session');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
            
                const data = await response.json();
                if (data.loggedIn) {
                    console.log('로그인 상태:', data.user);
                    userId = data.user.id; // 전역 변수에 userId를 저장
                    console.log('사용자 ID:', userId);
                } else {
                    console.log('로그인되지 않은 상태입니다.');
                }
            } catch (error) {
                console.error('로그인 상태 확인 중 오류:', error);
            }
        }
        fetchUserInfo();

        destinationInput.addEventListener('focus', () => {
            dropdown.style.display = 'block';
        });

        dropdown.addEventListener('click', (e) => {
            if (e.target.tagName === 'DIV') {
                destinationInput.value = e.target.textContent;
                destinationInput.dataset.countryIdx = e.target.dataset.countryIdx;
                dropdown.style.display = 'none';
                dateGroup.style.display = 'flex';
            }
        });

        document.getElementById('checkout').addEventListener('change', () => {
            guestGroup.style.display = 'flex';
        });

        travelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const country_idx = destinationInput.dataset.countryIdx;
            const start_date = document.getElementById('checkin').value;
            const end_date = document.getElementById('checkout').value;
            const companion_kid_YN = document.getElementById('child').checked ? 1 : 0;
            const companion_teenager_YN = document.getElementById('teen').checked ? 1 : 0;
            const companion_adult_YN = document.getElementById('adult').checked ? 1 : 0;
            const companion_pet_YN = document.getElementById('pet').checked ? 1 : 0;
            const companion_disabled_YN = document.getElementById('disabled').checked ? 1 : 0;
            
            try {
                const response = await fetch('/save-country', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ country_idx, userId, start_date, end_date,
                                           companion_kid_YN, companion_teenager_YN, companion_adult_YN,
                                           companion_pet_YN, companion_disabled_YN })
                });
            
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
            
                const data = await response.json();
                console.log(data.message);
            } catch (error) {
                console.error('Error:', error);
            }
        });
        

        // 페이지 로드 시 사용자 정보와 국가 데이터를 가져옴
        fetchUserInfo();
        fetchCountries();
    </script>
</body>

</html>
